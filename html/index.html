<!DOCTYPE html>
<html lang="en">
<header>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Library App</title>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" />

  <!-- Vue 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

  <!-- External CSS -->
  <link rel="stylesheet" href="/assets/style.css" />
</header>

<body>
  <div id="app">
    <!-- Header -->
    <header>
      <div class="header-content">
        <div class="logo">
          <i class="fa-solid fa-book-open-reader"></i>
          <h1>{{ sitename }}</h1>
        </div>

        <div class="search-container" v-if="showLessons">
          <div class="search-bar">
            <i class="fa-solid fa-magnifying-glass"></i>
            <input
              type="text"
              v-model="searchQuery"
              placeholder="Search lessons by subject, location, price..."
            />
            <button v-if="searchQuery" @click="clearSearch" class="clear-search">
              <i class="fa-solid fa-times"></i>
            </button>
          </div>
        </div>

        <div class="cart-button">
          <button @click="showCheckout" :disabled="cart.length === 0">
            <i class="fa-solid fa-cart-shopping"></i>
            <span v-if="itemsInTheCart">({{ itemsInTheCart }})</span> Checkout
          </button>
        </div>
      </div>
      <!-- ADD THIS RESET BUTTON -->
<div class="reset-button">
  <button @click="resetAllSpaces">
    <i class="fa-solid fa-rotate-right"></i> Reset Spaces
  </button>
</div>


      
    </header>

    <!-- Main Content -->
    <main>
      <!-- Sorting Controls -->
      <div class="sorting-controls" v-if="showLessons">
        <label>Sort by:</label>
        <select v-model="sortBy">
          <option value="subject">Subject</option>
          <option value="location">Location</option>
          <option value="price">Price</option>
          <option value="spaces">Availability</option>
        </select>

        <label>Order:</label>
        <select v-model="sortOrder">
          <option value="asc">Ascending</option>
          <option value="desc">Descending</option>
        </select>
      </div>

      <!-- Search Info -->
      <div v-if="showLessons && searchQuery" class="search-info">
        <p>Showing {{ filteredLessons.length }} results for "{{ searchQuery }}"</p>
      </div>

      <!-- Lessons -->
      <div v-if="showLessons">
        <figure v-for="lesson in sortedAndFilteredLessons" :key="lesson.id">
          <img :src="lesson.image" :alt="lesson.subject" />
          <h1>{{ lesson.subject }}</h1>
          <p><strong>Location:</strong> {{ lesson.location }}</p>
          <p><strong>Price:</strong> ¬£{{ lesson.price }}</p>
          <p><strong>Spaces Available:</strong> {{ lesson.spaces }}</p>

          <button v-if="canAddToCart(lesson.id)" @click="addItemToCart(lesson.id)">
            <i class="fa-solid fa-cart-plus"></i> Add to Cart
          </button>
          <button v-else disabled>
            <i class="fa-solid fa-ban"></i> Add to Cart
          </button>

          <button
            @click="removeItemFromCart(lesson.id)"
            :disabled="!canRemoveFromCart(lesson.id)"
          >
            <i class="fa-solid fa-trash-can"></i> Remove from Cart
          </button>

          <div v-if="!canAddToCart(lesson.id) && cart.length > 0">
            No more spaces available for this lesson
          </div>
        </figure>
      </div>

      <!-- Checkout Page -->
      <div v-else>
        <h1>Checkout</h1>

        <!-- Cart Items -->
        <div v-if="cart.length > 0">
          <h2>Your Selected Lessons:</h2>
          <div v-for="item in cartItems" :key="item.id">
            <h3>{{ item.subject }}</h3>
            <p>Price: ¬£{{ item.price }}</p>
            <p>Quantity: {{ item.quantity }}</p>
            <button @click="removeItemFromCart(item.id)">
              <i class="fa-solid fa-trash-can"></i> Remove
            </button>
          </div>

          <!-- Order Summary -->
          <div class="order-summary">
            <h2>Order Summary</h2>
            <p>Total Lessons: {{ totalItems }}</p>
            <p>Total Price: ¬£{{ totalPrice }}</p>
          </div>

          <!-- Checkout Form -->
          <checkout-form
            v-if="!orderSubmitted"
            :can-submit="canSubmitOrder"
            v-model:name="customerName"
            v-model:phone="customerPhone"
            @submit="submitOrder"
          ></checkout-form>

          <!-- Order Receipt -->
          <div v-if="orderSubmitted" class="receipt">
            <h2>Order Confirmation</h2>
            <p><strong>Name:</strong> {{ customerName }}</p>
            <p><strong>Phone:</strong> {{ customerPhone }}</p>
            <h3>Lessons Booked:</h3>
            <div v-for="item in cartItems" :key="item.id">
              <p>{{ item.quantity }} √ó {{ item.subject }} - ¬£{{ item.price * item.quantity }}</p>
            </div>
            <h3>Total Cost: ¬£{{ totalPrice }}</h3>
            <p><strong>Order submitted successfully!</strong></p>
          </div>
        </div>

        <!-- Empty Cart -->
        <div v-else>
          <h2>Your cart is empty</h2>
          <p>Add some lessons to your cart first!</p>
        </div>

        <button @click="goBack">
          <i class="fa-solid fa-arrow-left"></i> Go Back to Lessons
        </button>
      </div>
    </main>
  </div>
<script>
  var app = Vue.createApp({
    components: { 
      CheckoutForm: {
        template: `
          <div class="checkout-form">
            <h2>Student Information</h2>
            <input 
              type="text" 
              v-model.trim="localName" 
              placeholder="Your Name (e.g. John Doe)"
            >
            <input 
              type="text" 
              v-model.trim="localPhone" 
              placeholder="Your Phone Number (e.g. +44 7123 456789)"
            >
            <button @click="handleSubmit" :disabled="!canSubmit">
              <i class="fa-solid fa-credit-card"></i> Submit Order
            </button>
          </div>
        `,
        props: {
          canSubmit: Boolean,
          name: String,
          phone: String
        },
        emits: ['submit', 'update:name', 'update:phone'],
        data: function() {
          return {
            localName: this.name,
            localPhone: this.phone
          };
        },
        watch: {
          localName: function(val) { this.$emit('update:name', val); },
          localPhone: function(val) { this.$emit('update:phone', val); }
        },
        methods: {
          handleSubmit: function() {
            if (this.canSubmit) {
              this.$emit('submit');
            } else {
              alert("Please enter a valid name and phone number before submitting.");
            }
          }
        }
      }
    },
    data: function() {
      return {
        sitename: "Library Lesson Booking App",
        showLessons: true,
        sortBy: 'subject',
        sortOrder: 'asc',
        customerName: '',
        customerPhone: '',
        orderSubmitted: false,
        cart: [],
        searchQuery: '',
        lessons: [
          { id: 1001, subject: "Mathematics", location: "Hendon", price: 100, spaces: 5, image:  "../assets/images/maths.png" },
          { id: 1002, subject: "Physics", location: "Colindale", price: 80, spaces: 5, image: "../assets/images/physic.png" },
          { id: 1003, subject: "Chemistry", location: "Brent Cross", price: 90, spaces: 5, image: "../assets/images/chemistry.png" },
          { id: 1004, subject: "Biology", location: "Golders Green", price: 95, spaces: 5, image: "../assets/images/biology.png" },
          { id: 1005, subject: "History", location: "Camden", price: 70, spaces: 5, image: "../assets/images/history.png" },
          { id: 1006, subject: "English", location: "Ealing", price: 85, spaces: 5, image: "../assets/images/english.png" },
          { id: 1007, subject: "Computer Science", location: "Watford", price: 120, spaces: 5, image: "../assets/images/compsci.png" },
          { id: 1008, subject: "Art", location: "Hackney", price: 60, spaces: 5, image: "../assets/images/artbook.png" },
          { id: 1009, subject: "Music", location: "Stratford", price: 110, spaces: 5, image: "../assets/images/music.png" },
          { id: 1010, subject: "Economics", location: "Islington", price: 130, spaces: 5, image: "../assets/images/economicsbook.png" }
        ]
      };
    },
    computed: {
      itemsInTheCart: function() {
        return this.cart.length || "";
      },
      filteredLessons: function() {
        if (!this.searchQuery) return this.lessons;
        var q = this.searchQuery.toLowerCase();
        return this.lessons.filter(function(l) {
          return l.subject.toLowerCase().includes(q) ||
                 l.location.toLowerCase().includes(q) ||
                 l.price.toString().includes(q);
        });
      },
      sortedLessons: function() {
        var self = this;
        return [...this.filteredLessons].sort(function(a, b) {
          var aVal = typeof a[self.sortBy] === 'string' ? a[self.sortBy].toLowerCase() : a[self.sortBy];
          var bVal = typeof b[self.sortBy] === 'string' ? b[self.sortBy].toLowerCase() : b[self.sortBy];
          return self.sortOrder === 'asc' ? (aVal > bVal ? 1 : -1) : (aVal < bVal ? 1 : -1);
        });
      },
      sortedAndFilteredLessons: function() {
        return this.sortedLessons;
      },
      cartItems: function() {
        var counts = {};
        var self = this;
        this.cart.forEach(function(id) { 
          counts[id] = (counts[id] || 0) + 1; 
        });
        return Object.keys(counts).map(function(id) {
          var lesson = self.lessons.find(function(l) { 
            return l.id === parseInt(id); 
          });
          return { ...lesson, quantity: counts[id] };
        });
      },
      totalItems: function() {
        return this.cart.length;
      },
      totalPrice: function() {
        var self = this;
        return this.cartItems.reduce(function(sum, i) { 
          return sum + i.price * i.quantity; 
        }, 0);
      },
      canSubmitOrder: function() {
        var nameValid = /^[A-Za-z√Ä-√ñ√ò-√∂√∏-√ø'\-\s]{2,}$/.test(this.customerName.trim());
        var phoneValid = /^[0-9+\s]{6,}$/.test(this.customerPhone.trim());
        return this.cart.length > 0 && nameValid && phoneValid;
      }
    },
    methods: {
      showCheckout: function() {
        this.showLessons = false;
        this.orderSubmitted = false;
      },
      addItemToCart: function(id) {
        var lesson = this.lessons.find(function(l) { 
          return l.id === id; 
        });
        if (lesson && lesson.spaces > 0) {
          this.cart.push(id);
          lesson.spaces--;
        }
      },
      removeItemFromCart: function(id) {
        var i = this.cart.indexOf(id);
        if (i > -1) {
          this.cart.splice(i, 1);
          var lesson = this.lessons.find(function(l) { 
            return l.id === id; 
          });
          if (lesson) lesson.spaces++;
        }
      },
      goBack: function() {
        this.showLessons = true;
        this.orderSubmitted = false;
      },
      submitOrder: function() {
        var self = this;
        if (this.canSubmitOrder) {
          var orderData = {
            name: this.customerName,
            phone: this.customerPhone,
            lessonIDs: this.cart,
            totalPrice: this.totalPrice,
            totalItems: this.totalItems,
            orderDate: new Date().toISOString()
          };

          console.log("üì¶ Sending order data to backend:", orderData);

          fetch("http://localhost:3000/orders", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(orderData)
          })
          .then(function(res) {
            console.log("üì® Response status:", res.status, res.statusText);
            return res.json();
          })
          .then(function(data) {
            console.log("‚úÖ Server response data:", data);
            if (data.success && data.orderId) {
              console.log("‚úÖ Order successfully saved in MongoDB (CST3144 ‚Üí backendlibrary ‚Üí orders)");
              self.orderSubmitted = true;
              self.cart = [];
              self.customerName = '';
              self.customerPhone = '';
              alert("‚úÖ Order submitted successfully! It is now stored in the MongoDB 'orders' collection.");
              self.loadLessonsFromBackend();
            }
          })
          .catch(function(err) {
            console.error("‚ùå Error submitting order:", err);
          });
        }
      },
      canAddToCart: function(id) {
        var l = this.lessons.find(function(l) { 
          return l.id === id; 
        });
        return l && l.spaces > 0;
      },
      canRemoveFromCart: function(id) {
        return this.cart.includes(id);
      },
      clearSearch: function() {
        this.searchQuery = '';
      },
      // FIXED: Added missing closing brace and properly formatted resetAllSpaces method
      resetAllSpaces: function() {
        var self = this;
        if (confirm("Are you sure you want to reset all lesson spaces to 5?")) {
          fetch("http://localhost:3000/reset-lessons", {
            method: "PUT",
            headers: { "Content-Type": "application/json" }
          })
          .then(function(res) { 
            return res.json(); 
          })
          .then(function(data) {
            if (data.success) {
              alert("‚úÖ All lesson spaces have been reset to 5.");
              self.loadLessonsFromBackend(); // reload updated data
            } else {
              alert("‚ö†Ô∏è Failed to reset lessons: " + (data.message || "Unknown error"));
            }
          })
          .catch(function(err) {
            console.error("‚ùå Error resetting lessons:", err);
            alert("‚ùå Error connecting to backend. Please check your server.");
          });
        }
      },
      loadLessonsFromBackend: function() {
        var self = this;
        fetch("http://localhost:3000/lessons")
          .then(function(res) { 
            return res.json(); 
          })
          .then(function(lessonsFromBackend) {
            if (lessonsFromBackend && lessonsFromBackend.length > 0) {
              // Update ALL properties from backend to ensure complete sync
              self.lessons = lessonsFromBackend.map(function(backendLesson) {
                // Find the corresponding local lesson to preserve the correct image path
                var localLesson = self.lessons.find(function(local) {
                  return local.id === backendLesson.id;
                });
                
                return {
                  ...backendLesson, // This gets ALL updated data from backend
                  image: localLesson ? localLesson.image : "../assets/images/" + backendLesson.subject.toLowerCase().replace(/\s+/g, '') + ".png"
                };
              });
              console.log("‚úÖ Lessons fully synced from backend");
            }
          })
          .catch(function(err) {
            console.log("‚ùå Error loading from backend, using local data:", err);
          });
      }
    },
    mounted: function() {
      console.log("üöÄ Vue app mounted");
      console.log("üìö Lessons loaded:", this.lessons.length);
      console.log("üõí Cart initialized:", this.cart.length);
      this.loadLessonsFromBackend();
    }
  });

  var vm = app.mount("#app");
  window.vm = vm; // to access instance
</script>
</body>
</html>
